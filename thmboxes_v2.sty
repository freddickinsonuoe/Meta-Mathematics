\usepackage{amsmath, amssymb}
\usepackage{mdframed}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{xparse} 

% Define counters for each environment type
\newcounter{thmcounter}[section]
\newcounter{xmpcounter}[section]
\newcounter{rmkcounter}[section]
\newcounter{lmacounter}[section]
\newcounter{dfncounter}[section]

\renewcommand{\thethmcounter}{\arabic{section}.\arabic{thmcounter}}
\renewcommand{\thexmpcounter}{\arabic{section}.\arabic{xmpcounter}}
\renewcommand{\thermkcounter}{\arabic{section}.\arabic{rmkcounter}}
\renewcommand{\thelmacounter}{\arabic{section}.\arabic{lmacounter}}
\renewcommand{\thedfncounter}{\arabic{section}.\arabic{dfncounter}}

% For some reason the first in the sequence doesn't work.

% Remark environment
\NewDocumentEnvironment{rmk_fail}{o}{%
    \refstepcounter{rmkcounter}%
    \mdfsetup{
        frametitle={
            \tikz[baseline=(current bounding box.east),outer sep=0pt] 
            \node[anchor=east,rectangle,fill=red!30]
            {\strut Remark \thermkcounter:~#1};%
        },
        innertopmargin=0pt,
        linecolor=red!30,
        linewidth=2pt,
        topline=true,
        frametitleaboveskip=\dimexpr-\ht\strutbox\relax,
        backgroundcolor=red!10,
    }
    \begin{mdframed}[nobreak = true]\relax\raggedright
}{%
    \end{mdframed}
}


% From here, all environments work as expected! %
% ================== %

\NewDocumentEnvironment{xmp}{o}{%
    \refstepcounter{xmpcounter}%
    \mdfsetup{
        frametitle={
            \tikz[baseline=(current bounding box.east),outer sep=0pt] 
            \node[anchor=east,rectangle,fill=yellow!40]
            {\strut Example \thexmpcounter:~#1};%
        },
        innertopmargin=0pt,
        linecolor=yellow!40,
        linewidth=2pt,
        topline=true,
        frametitleaboveskip=\dimexpr-\ht\strutbox\relax,
        backgroundcolor=yellow!1,
    }
    \begin{mdframed}[nobreak = true]\relax\raggedright
}{%
    \end{mdframed}
}

\NewDocumentEnvironment{rmk}{o}{%
    \refstepcounter{rmkcounter}%
    \mdfsetup{
        frametitle={
            \tikz[baseline=(current bounding box.east),outer sep=0pt] 
            \node[anchor=east,rectangle,fill=red!30]
            {\strut Remark \thermkcounter:~#1};%
        },
        innertopmargin=0pt,
        linecolor=red!30,
        linewidth=2pt,
        topline=true,
        frametitleaboveskip=\dimexpr-\ht\strutbox\relax,
        backgroundcolor=red!10,
    }
    \begin{mdframed}[nobreak = true]\relax\raggedright
}{%
    \end{mdframed}
}

\NewDocumentEnvironment{dfn}{o}{%
    \refstepcounter{dfncounter}%
    \mdfsetup{
        frametitle={
            \tikz[baseline=(current bounding box.east),outer sep=0pt] 
            \node[anchor=east,rectangle,fill=blue!20]
            {\strut Definition \thedfncounter:~#1};%
        },
        innertopmargin=0pt,
        linecolor=blue!30,
        linewidth=2pt,
        topline=true,
        frametitleaboveskip=\dimexpr-\ht\strutbox\relax,
        backgroundcolor=blue!1,
    }
    \begin{mdframed}[nobreak = true]\relax\raggedright
}{%
    \end{mdframed}
}

% no counter for recall environment
\NewDocumentEnvironment{rcl}{o}{%
    \mdfsetup{
        frametitle={
            \tikz[baseline=(current bounding box.east),outer sep=0pt] 
            \node[anchor=east,rectangle,fill=magenta!2]
            {\strut Recall:~#1};%
        },
        innertopmargin=0pt,
        linecolor=magenta!2,
        linewidth=2pt,
        topline=true,
        frametitleaboveskip=\dimexpr-\ht\strutbox\relax,
        backgroundcolor=magenta!1,
    }
    \begin{mdframed}[nobreak = true]\relax\raggedright
}{%
    \end{mdframed}
}

\NewDocumentEnvironment{lma}{o}{%
    \refstepcounter{lmacounter}%
    \mdfsetup{
        frametitle={
            \tikz[baseline=(current bounding box.east),outer sep=0pt] 
            \node[anchor=east,rectangle,fill=orange!20]
            {\strut Lemma \thelmacounter:~#1};%
        },
        innertopmargin=0pt,
        linecolor=orange!20,
        linewidth=2pt,
        frametitleaboveskip=\dimexpr-\ht\strutbox\relax,
        backgroundcolor=orange!1,
    }
    \begin{mdframed}[nobreak = true]\relax\raggedright
}{%
    \end{mdframed}
}

\NewDocumentEnvironment{thm}{o}{%
    \refstepcounter{thmcounter}%
    \mdfsetup{%
        frametitle={
            \tikz[baseline=(current bounding box.east),outer sep=0pt] 
            \node[anchor=east,rectangle,fill=orange!20]{\strut Theorem \thethmcounter: #1};%
        },%
        innertopmargin=0pt,
        linecolor=orange!20,
        linewidth=2pt,
        topline=true,
        frametitleaboveskip=\dimexpr-\ht\strutbox\relax,
        backgroundcolor=orange!1,
    }%
    \begin{mdframed}[nobreak=true]\relax\raggedright
}{%
    \end{mdframed}%
}
